### **プロジェクト名： "はいぱか" (仮称: CardWeaver)**

**コンセプト：**
HyperCardの思想を現代のWeb技術で再実装し、誰もが直感的にインタラクティブなコンテンツを作成できる、ミニマルなオーサリングツール。

**ターゲットユーザー：**
*   プログラミング経験はないが、自分のアイデアを形にしたいと考えている人。
*   教育者、学生、アーティスト、プランナー。
*   かつてのHyperCardユーザー。

**コア思想：**
*   **手軽さと奥深さの両立：** GUI操作だけで基本的なことは完結し、JavaScriptを書くことで高度な拡張も可能にする。
*   **触れる喜び：** オブジェクトを直接操作する、手触り感のあるUIを提供する。
*   **Webネイティブ：** 作成したコンテンツは単一のHTMLファイルとして出力され、ブラウザさえあれば誰でも閲覧・実行できる。
*   **魔法への敬意:** 高度なスクリプティング機能へのアクセスには「Magic」というキーワードを要求。これにより、シンプルな操作とプログラミングの世界を意図的に分離し、オリジナルへのリスペクトと遊び心を表現する。
*   **AIとの共生（橋渡し）:** 複雑なAI機能を内蔵するのではなく、外部の汎用AIチャットサービス（Web版Gemini, ChatGPT等）へのリンクを提示。ユーザーが外部でコードを生成し、それを本ツールに持ち込んで利用する、という明確なワークフローを案内する。
*   **グローバルな視点:** 初期設計から多言語対応を考慮し、世界中の誰もが母国語で利用できることを目指す。

---

### **機能仕様**

**1. 基本構造**

*   **スタック (Stack):** プロジェクト全体を指す。単一のHTMLファイルとして保存される。
*   **カード (Card):** スタックを構成する各ページ。ユーザーは複数のカードを作成し、それらを切り替えて表示する。
*   **オブジェクト (Object):** カードの上に配置できる要素。以下の種類がある。
    *   テキストボックス
    *   ボタン
    *   画像
    *   動画

**2. UI/UX**

*   **メインビュー:** 現在選択されているカードを表示するキャンバス領域。
*   **カード一覧パネル:** スタック内の全カードをサムネイルで一覧表示し、クリックで選択・移動できる。カードの追加、削除、並べ替えもここで行う。
*   **スタートカード設定:** いずれかのカードを「スタートカード」（最初に表示されるカード）として設定できる機能を設ける。
*   **オブジェクトの作成:**
    *   メインビューのキャンバス領域で右クリックすると、コンテキストメニューが表示される。
    *   メニューから「ボタンを追加」「画像を追加」などを選択すると、カーソル位置にオブジェクトが生成される。
*   **オブジェクトの操作:**
    *   すべてのオブジェクトは、ドラッグ＆ドロップで自由に移動できる。
    *   オブジェクトの四隅や辺をドラッグすることで、直感的にリサイズできる。
*   **オブジェクトの整列:**
    *   複数のオブジェクトを選択した状態で、上部メニューの「レイアウト」から整列機能を利用できる。
    *   少なくとも「左ぞろえ」「中央ぞろえ（垂直軸）」「右ぞろえ」などを提供する。
*   ✅ **プロパティパネル:**
    *   ✅ いずれかのオブジェクトを選択すると、画面の右側にそのオブジェクト専用のプロパティパネルが表示される。
    *   ✅ これにより、選択中のオブジェクトの見た目や動作を詳細に設定する。

**2. オブジェクトごとのプロパティ**

*   **テキストボックス:**
    *   ✅ 内容の編集 (WYSIWYG)
    *   ✅ フォントファミリー、サイズ、色、太字、斜体、下線の設定
    *   ❌ 組み方向:「縦書き」「横書き」機能は未実装
    *   ✅ 文字揃え:「左揃え」「中央揃え」「右揃え」を実装済み
*   **画像 / 動画:**
    *   ✅ ソースの指定（ローカルからアップロード or URL指定）。
    *   ✅ 代替テキストの設定。
    *   ✅ objectFit (contain/fill)
    *   **ファイルサイズ制限:** ユーザビリティと出力ファイルの肥大化を防ぐため、アップロード可能なファイルサイズに上限を設ける（例: 画像 5MB, 動画 50MB）。プロパティパネルには、上限と現在のファイルサイズを併記する。
    *   **動画の再生時間:** 動画は再生時間に上限を設ける（例: 60秒）。
*   **ボタン:**
    *   ✅ **表示:** ラベルテキストの変更
    *   ✅ **アクション (onclickイベント):** 以下の動作をプロパティパネルのプルダウンから選択可能（実装済み）。
        1.  ✅ **なし**
        2.  ✅ **カードへ移動:** 移動先のカードを、カード一覧から選択する。
        3.  ✅ **URLを開く:** 対象のURLを入力する。
        4.  ✅ **アンカーリンクでカードへ移動:** HTMLエクスポート時のローカル対応機能
        5.  ✅ **カスタムJavaScriptを実行 (要アンロック):** Magic機能で実装済み。
            *   **アンロック演出:** プロパティパネル等にある「魔法(Magic)」ボタンを押すと、専用のモーダルウィンドウが開く。モーダルには、「ブラウジング」「オーサリング」「スクリプティング」の3段階のユーザーレベルを選択するラジオボタンが表示される。「スクリプティング」のラジオボタンの横にはテキスト入力エリアがあり、ここに「Magic」と入力すると、さらに右にある「アンロック」スライドボタンが操作可能になる。ユーザーがこのスライドボタンを操作することで、スクリプト機能が有効になる。
            *   **アンロック後:** コードエディタが有効になる。エディタの近くに外部AIチャットへのリンクを設置。「このリンク先のAIに『こういう動きをするスクリプトを書いて』とお願いして、出来上がったコードをここに貼り付けてください」といったメッセージで、具体的な利用方法を案内する。
*   **図形:**
    *   **種類の選択:** 「四角」「丸」「三角」「動画」「音楽」などから選択できる。
    *   **塗りつぶしの色:** カラーピッカーで色を指定できる。
    *   **線の色と太さ:** 線の色と太さ（px単位など）を指定できる。
    *   **メディアコンテンツ:** 動画や音楽を選択した場合、ファイルアップロードやURL指定が可能。

**4. 技術仕様**

*   ✅ **開発言語:** TypeScript + React (実装済み)
*   ✅ **ビルドツール:** Vite (実装済み)
*   ✅ **UIライブラリ:** Material-UI (MUI) v5 (実装済み)
*   ✅ **状態管理:** React useState/useEffect (実装済み)
*   ✅ **多言語対応 (i18n):**
    *   ✅ UI上のすべてのテキストはハードコーディングせず、`i18next`のような専門ライブラリを用いて管理する。
    *   ✅ 言語ごとに翻訳ファイル（例: `en.json`, `ja.json`）を用意し、動的に切り替えられる構造を初期段階から導入する。
    *   ✅ 言語切り替えスイッチの移植
*   ✅ **フレームワーク/ライブラリ (実装済み):**
    *   ✅ **UIコンポーネントライブラリ:** `Material-UI (MUI)` を採用・実装済み。
        *   **実装状況:** プロパティパネル、設定モーダル、カード一覧パネルなどで活用。
    *   ❌ **キャンバスライブラリ:** `Konva.js` は未実装。
        *   **現在の実装:** DOMベースでオブジェクト操作を実現。
        *   **将来の検討事項:** より高度なキャンバス操作が必要になった場合に導入を検討。
    *   ✅ **開発環境:** `Vite` + `TypeScript` + `React` で実装済み。
    *   ❌ **オブジェクト操作:** `interact.js` は未使用。
        *   **現在の実装:** Reactの標準的なイベントハンドリングとCSS transformでドラッグ・リサイズを実現。
    *   ✅ **レンダリング:** DOMベースで実装済み。各オブジェクトはHTML要素として描画。
*   ✅ **出力形式:**
    *   ✅ 作成したスタックは、すべてのカード情報、オブジェクト情報、スクリプトを含んだ、単一の自己完結した `.html` ファイルとしてエクスポート可能（実装済み）。
    *   ✅ 画像等のリソースはURL参照で実装済み。Base64埋め込みは将来の拡張として検討。
    *   ✅ **ローカルファイル対応:** JavaScriptが制限される環境でも動作するよう、アンカーリンクによるカード切り替え機能を実装。
    *   ✅ **サンプルゲーム:** じゃんけんゲームなどのインタラクティブなサンプルが含まれ、ローカルファイルでも完全動作。
*   🔄 **プロジェクト保存・読み込み機能 (新規仕様):**
    *   📋 **JSON形式での保存:** 作業中のスタック全体をJSON形式でローカルファイルとして保存可能。
        *   **保存内容:** カード情報、オブジェクト情報、スクリプト、設定情報を含む完全なプロジェクトデータ
        *   **ファイル形式:** `.hipacka` または `.json` 拡張子
        *   **保存方法:** ブラウザのダウンロード機能を使用したクライアントサイド保存
    *   📋 **JSON形式での読み込み:** 保存されたプロジェクトファイルの読み込み・復元機能。
        *   **読み込み方法:** ファイル選択ダイアログまたはドラッグ&ドロップ
        *   **バリデーション:** ファイル形式・データ構造の検証機能
        *   **エラーハンドリング:** 不正なファイルや古いバージョンへの対応
    *   📋 **作業の一時保存:** 編集中の作業を中断・再開可能にする機能。
        *   **自動保存:** 一定間隔での自動保存機能（ローカルストレージ使用）
        *   **復元機能:** ブラウザ再起動時の作業復元
        *   **複数プロジェクト管理:** 複数のプロジェクトの並行作業対応

---

### **5. 公開・デプロイ戦略**

**1. 基本的な考え方 (クライアントサイド・完結モデル)**
*   本ツールは、サーバーサイドでのデータ保存を必要としない、クライアントサイドで完結するWebアプリケーションとして設計する。
*   オーサリング（編集）機能はすべてユーザーのブラウザ上で実行される。
*   作成されたコンテンツ（スタック）は、サーバーに保存されるのではなく、ユーザーが自身のPCに `.html` ファイルとしてダウンロード（エクスポート）する形で提供される。

**2. 公開プラットフォーム**
*   **Netlify / Vercel / GitHub Pages 等の静的ホスティングサービス**
    *   **理由:** 本ツール自体はサーバーサイドの動的な処理を必要としないため、静的サイトとして容易に、かつ無料で公開できる。ユーザーはURLにアクセスするだけで、すぐにツールを利用開始できる。

**3. メリット**
*   **開発・運用のシンプル化:** サーバーやデータベースの構築・管理が不要なため、開発者はフロントエンドの機能開発に集中できる。
*   **ユーザーのプライバシー保護:** ユーザーが作成したデータは開発者側では一切保持しないため、プライバシーが完全に保護される。
*   **ポータビリティ:** ユーザーは書き出したHTMLファイルをWebサーバーにアップロードしたり、メールで送ったりと、自由に配布・利用できる。
*   **HyperCardの思想の継承:** 個人のコンピュータ内で創造的な作業が完結するという、オリジナルのHyperCardが持っていた思想をWeb上で再現する。

---

### **6. ライブラリ導入とReactへの移行 (✅ 完了済み)**

~~現在のDOMベースの実装から、UI構築の効率化と将来の拡張性向上のため、ReactおよびUIライブラリ（Material-UI, Konva.js）を導入します。~~

**✅ 移行完了状況:**
Reactベースの実装が完了し、以下の構成で稼働中：

**ステップ1: 必要なライブラリのインストール**

まず、開発に必要なライブラリをnpmでインストールします。

```bash
# Reactと関連ライブラリ
npm install react react-dom @types/react @types/react-dom

# Material-UIと関連ライブラリ
npm install @mui/material @emotion/react @emotion/styled

# Konva.jsとReact用ラッパー
npm install konva react-konva

# Vite用のReactプラグイン (開発依存)
npm install -D @vitejs/plugin-react
```

**ステップ2: Vite設定の更新**

`vite.config.js` を編集し、Reactをプロジェクトで利用できるように設定します。

*   `@vitejs/plugin-react` をインポートします。
*   `plugins` 配列に `react()` を追加します。

**ステップ3: プロジェクト構造のReact化**

1.  **エントリーポイントの変更:**
    *   `src/main.ts` を `src/main.tsx` にリネームします。
    *   `index.html` の `<script>` タグの `src` 属性を `/src/main.tsx` に更新します。

2.  **Appコンポーネントの作成:**
    *   `src/App.tsx` を新規作成します。これがアプリケーションのルートコンポーネントになります。
    *   `main.tsx` の中身を、この `App.tsx` をレンダリングする定型コードに置き換えます。

**ステップ4: UIコンポーネントの作成とレイアウト構築**

仕様書に基づき、UIを構成する主要なReactコンポーネントの雛形を作成します。

1.  `src/components` ディレクトリを作成します。
2.  以下のコンポーネントファイルを作成します。
    *   `Layout.tsx`: Material-UIの `Box` や `Grid` を用いて、全体の3カラムレイアウト（カード一覧、メインキャンバス、プロパティパネル）を構築します。
    *   `CardCanvas.tsx`: `react-konva` を用いて、Konvaの `Stage` と `Layer` を配置するキャンバス領域を作成します。
    *   `CardListPanel.tsx`: カード一覧を表示するパネルです。
    *   `PropertiesPanel.tsx`: 選択されたオブジェクトのプロパティを編集するパネルです。

**ステップ5: 既存ロジックの段階的な移行**

現在の `main.ts` に書かれている状態管理や描画ロジックを、新しく作成したReactコンポーネントへ段階的に移行していきます。

*   **状態管理:** `stack` や `selectedObject` などの状態は、Reactの `useState` やコンテキストを用いて管理するように変更します。
*   **描画ロジック:** `renderAll` や `createDOMElement` などの関数は、各コンポーネントのJSX内に置き換えられます。`interact.js` による操作も、Reactのイベントハンドリングや `useEffect` フックと統合します。

### **7. 将来の機能拡張**

*   **操作の取り消し・やり直し (Undo/Redo):**
    *   ユーザーの操作履歴を管理し、Ctrl+Z (取り消し) および Ctrl+Y (やり直し) で、直前の状態に戻したり進めたりできる機能。
    *   実装には、アプリケーションの状態変化を記録・復元する仕組みが必要となり、複雑な設計が求められる。
    *   今後の重要な機能として検討する。

### **8. プロジェクト保存・読み込み機能の実装アイデア**

**基本実装:**
*   **保存機能:** `JSON.stringify(stack)` でスタックデータをシリアライズし、Blob APIでファイルダウンロード
*   **読み込み機能:** File API + FileReader でJSONファイルを読み取り、`JSON.parse()` でデータ復元
*   **UI配置:** カード一覧パネルに「保存」「読み込み」ボタンを追加

**追加実装アイデア:**

1. **ローカルストレージ自動保存**
   *   `localStorage` を使用した定期的な自動保存（5分間隔など）
   *   ブラウザクラッシュ時の作業復旧機能
   *   「前回の作業を復元しますか？」ダイアログ

2. **プロジェクト履歴管理**
   *   最近開いたプロジェクトの履歴表示
   *   プロジェクト名・最終更新日時の管理
   *   クイックアクセス機能

3. **テンプレート機能**
   *   よく使用するカード構成をテンプレートとして保存
   *   「新規プロジェクト」時にテンプレート選択
   *   サンプルテンプレートの提供

4. **バージョン管理**
   *   プロジェクトファイルにバージョン情報を埋め込み
   *   古いバージョンとの互換性維持
   *   マイグレーション機能

5. **インポート・エクスポート拡張**
   *   他のツールからのデータインポート
   *   画像ファイルの一括インポート
   *   プロジェクト設定のエクスポート

6. **クラウド連携（将来的）**
   *   GitHub Gist連携での簡易クラウド保存
   *   Google Drive API連携
   *   ブラウザ間でのプロジェクト同期

**技術的考慮事項:**
*   ファイルサイズ制限の設定
*   画像データの取り扱い（URL参照 vs Base64埋め込み）
*   エラーハンドリングとユーザーフィードバック
*   セキュリティ（XSS対策、ファイル検証）

### **9. 実装状況と既知の問題 (2025-09-17更新)**

**✅ 解決済みの問題:**
*   TypeScriptビルドエラー - 未使用インポート、型エラーなどを修正済み
*   HTMLエクスポートのローカル動作 - JavaScript実行とアンカーナビゲーション対応済み
*   プロパティパネルの多言語化 - 完全対応済み
*   カードスタック表示の修正 - 重なり表示を正しく実装済み

**⚠️ 現在の制限事項:**
*   Konva.jsは未導入（DOMベース実装で十分機能している）
*   Base64画像埋め込みは未実装（URL参照で対応中）
*   縦書きテキスト機能は未実装
*   Undo/Redo機能は将来の拡張として保留

**🔧 技術的な改善点:**
*   ビルドサイズの最適化が推奨（現在791KB）
*   コード分割の検討
*   パフォーマンス最適化の余地あり
---

### **10. 翻訳作業状況 (2025-09-17更新)**

*   ✅ **PropertiesPanel.tsx**: 翻訳完了（ボタンアクション、カード選択UI含む）
*   ✅ **CardListPanel.tsx**: 翻訳完了
*   ✅ **SettingsModal.tsx**: 翻訳完了
*   ✅ **HTMLエクスポート**: セキュリティ警告メッセージの多言語対応完了
*   ✅ **全体的な多言語対応**: 日本語・英語の完全対応済み
