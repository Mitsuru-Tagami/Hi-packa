### **プロジェクト名： "はいぱか" (仮称: CardWeaver)**

**コンセプト：**
HyperCardの思想を現代のWeb技術で再実装し、誰もが直感的にインタラクティブなコンテンツを作成できる、ミニマルなオーサリングツール。

**ターゲットユーザー：**
*   プログラミング経験はないが、自分のアイデアを形にしたいと考えている人。
*   教育者、学生、アーティスト、プランナー。
*   かつてのHyperCardユーザー。

**コア思想：**
*   **手軽さと奥深さの両立：** GUI操作だけで基本的なことは完結し、JavaScriptを書くことで高度な拡張も可能にする。
*   **触れる喜び：** オブジェクトを直接操作する、手触り感のあるUIを提供する。
*   **Webネイティブ：** 作成したコンテンツは単一のHTMLファイルとして出力され、ブラウザさえあれば誰でも閲覧・実行できる。
*   **魔法への敬意:** 高度なスクリプティング機能へのアクセスには「Magic」というキーワードを要求。これにより、シンプルな操作とプログラミングの世界を意図的に分離し、オリジナルへのリスペクトと遊び心を表現する。
*   **AIとの共生（橋渡し）:** 複雑なAI機能を内蔵するのではなく、外部の汎用AIチャットサービス（Web版Gemini, ChatGPT等）へのリンクを提示。ユーザーが外部でコードを生成し、それを本ツールに持ち込んで利用する、という明確なワークフローを案内する。
*   **グローバルな視点:** 初期設計から多言語対応を考慮し、世界中の誰もが母国語で利用できることを目指す。

---

### **機能仕様**

**1. 基本構造**

*   **スタック (Stack):** プロジェクト全体を指す。単一のHTMLファイルとして保存される。
*   **カード (Card):** スタックを構成する各ページ。ユーザーは複数のカードを作成し、それらを切り替えて表示する。
*   **オブジェクト (Object):** カードの上に配置できる要素。以下の種類がある。
    *   テキストボックス
    *   ボタン
    *   画像
    *   動画

**2. UI/UX**

*   **メインビュー:** 現在選択されているカードを表示するキャンバス領域。
*   **カード一覧パネル:** スタック内の全カードをサムネイルで一覧表示し、クリックで選択・移動できる。カードの追加、削除、並べ替えもここで行う。
*   **スタートカード設定:** いずれかのカードを「スタートカード」（最初に表示されるカード）として設定できる機能を設ける。
*   **オブジェクトの作成:**
    *   メインビューのキャンバス領域で右クリックすると、コンテキストメニューが表示される。
    *   メニューから「ボタンを追加」「画像を追加」などを選択すると、カーソル位置にオブジェクトが生成される。
*   **オブジェクトの操作:**
    *   すべてのオブジェクトは、ドラッグ＆ドロップで自由に移動できる。
    *   オブジェクトの四隅や辺をドラッグすることで、直感的にリサイズできる。
*   **オブジェクトの整列:**
    *   複数のオブジェクトを選択した状態で、上部メニューの「レイアウト」から整列機能を利用できる。
    *   少なくとも「左ぞろえ」「中央ぞろえ（垂直軸）」「右ぞろえ」などを提供する。
*   ✅ **プロパティパネル:**
    *   ✅ いずれかのオブジェクトを選択すると、画面の右側にそのオブジェクト専用のプロパティパネルが表示される。
    *   ✅ これにより、選択中のオブジェクトの見た目や動作を詳細に設定する。

**3. オブジェクトごとのプロパティ**

*   **テキストボックス:**
    *   ✅ 内容の編集 (WYSIWYG)
    *   ✅ フォントファミリー、サイズ、色、太字、斜体、下線の設定
    *   組み方向:「縦書き」「横書き」をラジオボタンで選択できる。
    *   文字揃え:「左揃え」「中央揃え」「右揃え」「ジャスティファイ（両端揃え）」を選択できる。
*   **画像 / 動画:**
    *   ✅ ソースの指定（ローカルからアップロード or URL指定）。
    *   ✅ 代替テキストの設定。
    *   ✅ objectFit (contain/fill)
    *   **ファイルサイズ制限:** ユーザビリティと出力ファイルの肥大化を防ぐため、アップロード可能なファイルサイズに上限を設ける（例: 画像 5MB, 動画 50MB）。プロパティパネルには、上限と現在のファイルサイズを併記する。
    *   **動画の再生時間:** 動画は再生時間に上限を設ける（例: 60秒）。
*   **ボタン:**
    *   ✅ **表示:** ラベルテキストの変更
    *   **アクション (onclickイベント):** 以下の動作をプロパティパネルのプルダウンから選択する。
        1.  **なし**
        2.  **カードへ移動:** 移動先のカードを、カード一覧から選択する。
        3.  **URLを開く:** 対象のURLを入力する。
        4.  **カスタムJavaScriptを実行 (要アンロック):** 初めはロックされており、以下の手順でアンロックする。
            *   **アンロック演出:** プロパティパネル等にある「魔法(Magic)」ボタンを押すと、専用のモーダルウィンドウが開く。モーダルには、「ブラウジング」「オーサリング」「スクリプティング」の3段階のユーザーレベルを選択するラジオボタンが表示される。「スクリプティング」のラジオボタンの横にはテキスト入力エリアがあり、ここに「Magic」と入力すると、さらに右にある「アンロック」スライドボタンが操作可能になる。ユーザーがこのスライドボタンを操作することで、スクリプト機能が有効になる。
            *   **アンロック後:** コードエディタが有効になる。エディタの近くに外部AIチャットへのリンクを設置。「このリンク先のAIに『こういう動きをするスクリプトを書いて』とお願いして、出来上がったコードをここに貼り付けてください」といったメッセージで、具体的な利用方法を案内する。
*   **図形:**
    *   **種類の選択:** 「四角」「丸」「三角」などから選択できる。
    *   **塗りつぶしの色:** カラーピッカーで色を指定できる。
    *   **線の色と太さ:** 線の色と太さ（px単位など）を指定できる。
*   **図形:**
    *   **種類の選択:** 「四角」「丸」「三角」などから選択できる。
    *   **塗りつぶしの色:** カラーピッカーで色を指定できる。
    *   **線の色と太さ:** 線の色と太さ（px単位など）を指定できる。

**4. 技術仕様**

*   **開発言語:** TypeScript
*   ✅ **多言語対応 (i18n):**
    *   ✅ UI上のすべてのテキストはハードコーディングせず、`i18next`のような専門ライブラリを用いて管理する。
    *   ✅ 言語ごとに翻訳ファイル（例: `en.json`, `ja.json`）を用意し、動的に切り替えられる構造を初期段階から導入する。
    *   ✅ 言語切り替えスイッチの移植
*   **フレームワーク/ライブラリ (候補リスト):**
    *   **UIコンポーネントライブラリ:** アプリケーションのメニューやプロパティパネル等のUI部品を効率的に実装するために使用。
        *   候補: `Material-UI`, `Ant Design`
    *   **キャンバスライブラリ:** `Konva.js` を使用する。
        *   **選定理由:** 特定の用途に特化せず、テキスト、図形、画像等をキャンバス上に自由に配置・操作できる汎用性の高さが「はいぱか」のコンセプトと合致するため。公式デモ（Canvas Editor）が、目指す機能の優れたお手本となる。
        *   **実装方針:** カードの向きの変更（90度単位）、およびカード上のオブジェクトの自由な配置、拡大縮小、回転（オブジェクト回転の優先度は低）といった操作性を実現する。
    *   **開発環境:** `Vite`
    *   **オブジェクト操作:** `interact.js` (ドラッグ、ドロップ、リサイズ機能の実装)
    *   **レンダリング:** 素のHTML/CSS/JS (DOMベース) で実装する。各オブジェクト（テキスト、ボタン等）はHTML要素としてDOMツリーに直接描画される。これにより、Web標準との親和性やアクセシビリティを確保する。
*   **出力形式:**
    *   作成したスタックは、すべてのカード情報、オブジェクト情報、スクリプトを含んだ、単一の自己完結した `.html` ファイルとしてエクスポートされる。
    *   ユーザーがアップロードした画像等のバイナリファイルは、Base64形式にエンコードされ、HTMLファイル内に埋め込まれる。

---

### **5. 公開・デプロイ戦略**

**1. 基本的な考え方 (クライアントサイド・完結モデル)**
*   本ツールは、サーバーサイドでのデータ保存を必要としない、クライアントサイドで完結するWebアプリケーションとして設計する。
*   オーサリング（編集）機能はすべてユーザーのブラウザ上で実行される。
*   作成されたコンテンツ（スタック）は、サーバーに保存されるのではなく、ユーザーが自身のPCに `.html` ファイルとしてダウンロード（エクスポート）する形で提供される。

**2. 公開プラットフォーム**
*   **Netlify / Vercel / GitHub Pages 等の静的ホスティングサービス**
    *   **理由:** 本ツール自体はサーバーサイドの動的な処理を必要としないため、静的サイトとして容易に、かつ無料で公開できる。ユーザーはURLにアクセスするだけで、すぐにツールを利用開始できる。

**3. メリット**
*   **開発・運用のシンプル化:** サーバーやデータベースの構築・管理が不要なため、開発者はフロントエンドの機能開発に集中できる。
*   **ユーザーのプライバシー保護:** ユーザーが作成したデータは開発者側では一切保持しないため、プライバシーが完全に保護される。
*   **ポータビリティ:** ユーザーは書き出したHTMLファイルをWebサーバーにアップロードしたり、メールで送ったりと、自由に配布・利用できる。
*   **HyperCardの思想の継承:** 個人のコンピュータ内で創造的な作業が完結するという、オリジナルのHyperCardが持っていた思想をWeb上で再現する。

---

### **6. ライブラリ導入とReactへの移行手順**

現在のDOMベースの実装から、UI構築の効率化と将来の拡張性向上のため、ReactおよびUIライブラリ（Material-UI, Konva.js）を導入します。以下にその手順を示します。

**ステップ1: 必要なライブラリのインストール**

まず、開発に必要なライブラリをnpmでインストールします。

```bash
# Reactと関連ライブラリ
npm install react react-dom @types/react @types/react-dom

# Material-UIと関連ライブラリ
npm install @mui/material @emotion/react @emotion/styled

# Konva.jsとReact用ラッパー
npm install konva react-konva

# Vite用のReactプラグイン (開発依存)
npm install -D @vitejs/plugin-react
```

**ステップ2: Vite設定の更新**

`vite.config.js` を編集し、Reactをプロジェクトで利用できるように設定します。

*   `@vitejs/plugin-react` をインポートします。
*   `plugins` 配列に `react()` を追加します。

**ステップ3: プロジェクト構造のReact化**

1.  **エントリーポイントの変更:**
    *   `src/main.ts` を `src/main.tsx` にリネームします。
    *   `index.html` の `<script>` タグの `src` 属性を `/src/main.tsx` に更新します。

2.  **Appコンポーネントの作成:**
    *   `src/App.tsx` を新規作成します。これがアプリケーションのルートコンポーネントになります。
    *   `main.tsx` の中身を、この `App.tsx` をレンダリングする定型コードに置き換えます。

**ステップ4: UIコンポーネントの作成とレイアウト構築**

仕様書に基づき、UIを構成する主要なReactコンポーネントの雛形を作成します。

1.  `src/components` ディレクトリを作成します。
2.  以下のコンポーネントファイルを作成します。
    *   `Layout.tsx`: Material-UIの `Box` や `Grid` を用いて、全体の3カラムレイアウト（カード一覧、メインキャンバス、プロパティパネル）を構築します。
    *   `CardCanvas.tsx`: `react-konva` を用いて、Konvaの `Stage` と `Layer` を配置するキャンバス領域を作成します。
    *   `CardListPanel.tsx`: カード一覧を表示するパネルです。
    *   `PropertiesPanel.tsx`: 選択されたオブジェクトのプロパティを編集するパネルです。

**ステップ5: 既存ロジックの段階的な移行**

現在の `main.ts` に書かれている状態管理や描画ロジックを、新しく作成したReactコンポーネントへ段階的に移行していきます。

*   **状態管理:** `stack` や `selectedObject` などの状態は、Reactの `useState` やコンテキストを用いて管理するように変更します。
*   **描画ロジック:** `renderAll` や `createDOMElement` などの関数は、各コンポーネントのJSX内に置き換えられます。`interact.js` による操作も、Reactのイベントハンドリングや `useEffect` フックと統合します。

### **7. 将来の機能拡張**

*   **操作の取り消し・やり直し (Undo/Redo):**
    *   ユーザーの操作履歴を管理し、Ctrl+Z (取り消し) および Ctrl+Y (やり直し) で、直前の状態に戻したり進めたりできる機能。
    *   実装には、アプリケーションの状態変化を記録・復元する仕組みが必要となり、複雑な設計が求められる。
    *   今後の重要な機能として検討する。

### **8. 既知の問題**
    *   右ペインのプロパティをスクロールさせようとしたが、エラーがおきてループに入る　2025-09-08
    *   おそらく、中央のキャンバスサイズ変更の実装時にも同様のエラーが起きる可能性がある注意　2025-09-08　以前のバージョンにて発生
Gemini CLI との作業における既知の問題点

  1. 最も深刻な問題: `write_file` ツールの動作不良
   - 現象: Gemini CLIがファイルを書き換える際に、内部では成功と報告されるが、実際に
     はファイルの内容が更新されない、または変更が反映されない。
   - 影響: Gemini
     CLIが直接コードを修正する作業が信頼できない。手動でのコピペが必要となる。
   - 根本原因: 不明。開発チームに緊急報告済み。

  2. アプリケーション起動時の `SyntaxError` の再発
   - 現象: Uncaught SyntaxError: Expected declaration but found ‘[’. が Hi-packa:1:1
     で発生し、アプリケーションが正常に起動しない場合がある。
   - 影響: アプリケーションのJavaScriptバンドルが破損している可能性があり、開発サー
     バー（Vite）のキャッシュやビルドプロセスに問題がある可能性。
   - 関連:
     viteのバージョンを^5.0.2にダウングレードしたが、根本的な解決には至っていない。

  3. 「全てのオブジェクトでスクリプトを許可」機能の動作不良
   - 現象: 設定画面のトグルスイッチが、マジックワード入力後も有効にならない。
   - 影響: この機能は現在動作せず、実装が複雑なため一旦保留・削除の方向で検討中。
   - 関連: isMagicEnabledの状態管理やプロパティの伝達に問題がある可能性。

  4. カード名の編集機能の動作不良
   - 現象: プロパティパネルでカード名を編集しても、変更が反映されない。
   - 影響: カード名の変更ができない。
   - 関連: onUpdateCardNameプロパティの伝達やPropertiesPanel.tsx内のロジックに問題が
     ある可能性。

  5. その他の軽微な問題
   - MUI Gridの警告: itemやxsプロパティが非推奨であるという警告。機能には影響しない
     が、将来的なMUIのバージョンアップで問題になる可能性。
   - 画像読み込みエラー: Failed to load image: 
     ...という警告。機能には影響しないが、画像が表示されない可能性。
---

### **9. 翻訳作業状況**

*   **PropertiesPanel.tsx**: 翻訳作業中
*   **CardListPanel.tsx**: 翻訳完了
*   **SettingsModal.tsx**: 翻訳作業中
